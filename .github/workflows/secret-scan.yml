name: Secret Scan Validation

on:
  push:
    branches: [ main, master, develop, Maayan, Idit ]
  pull_request:
    branches: [ main, master, develop , Maayan, Idit ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Fetch full history for better secret detection
        fetch-depth: 0

    - name: Run TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    - name: Run GitLeaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE}} # Only required for Gitleaks Enterprise

    - name: Run Semgrep for Secrets
      uses: returntocorp/semgrep-action@v1
      with:
        config: >- 
          p/security-audit
          p/secrets
          p/owasp-top-10
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

    - name: Run detect-secrets
      run: |
        pip install detect-secrets
        detect-secrets scan --all-files --baseline .secrets.baseline
        if [ -f .secrets.baseline ]; then
          detect-secrets audit .secrets.baseline
        fi

    - name: Setup Node.js for additional tools
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install and run secretlint
      run: |
        npm install -g @secretlint/cli @secretlint/secretlint-rule-preset-recommend
        echo '{
          "rules": [
            {
              "id": "@secretlint/secretlint-rule-preset-recommend"
            }
          ]
        }' > .secretlintrc.json
        secretlint "**/*"

    - name: Custom Secret Patterns Check
      run: |
        echo "Checking for common secret patterns..."
        
        # Check for common secret patterns
        SECRET_PATTERNS=(
          "password\s*=\s*['\"][^'\"]{8,}['\"]"
          "api_key\s*=\s*['\"][^'\"]{20,}['\"]"
          "secret\s*=\s*['\"][^'\"]{20,}['\"]"
          "token\s*=\s*['\"][^'\"]{20,}['\"]"
          "AKIA[0-9A-Z]{16}"  # AWS Access Key
          "sk-[a-zA-Z0-9]{48}" # OpenAI API Key
          "xoxb-[0-9]{11}-[0-9]{12}-[a-zA-Z0-9]{24}" # Slack Bot Token
          "ghp_[a-zA-Z0-9]{36}" # GitHub Personal Access Token
        )
        
        FOUND_SECRETS=false
        
        for pattern in "${SECRET_PATTERNS[@]}"; do
          echo "Checking pattern: $pattern"
          if grep -r -E "$pattern" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.yml" --exclude="*.yaml"; then
            echo "‚ö†Ô∏è  Potential secret found matching pattern: $pattern"
            FOUND_SECRETS=true
          fi
        done
        
        if [ "$FOUND_SECRETS" = true ]; then
          echo "‚ùå Potential secrets detected in the codebase!"
          exit 1
        else
          echo "‚úÖ No secrets detected by custom patterns."
        fi

    - name: Check for high-entropy strings
      run: |
        python3 << 'EOF'
        import os
        import re
        import math
        from collections import Counter

        def calculate_entropy(string):
            """Calculate Shannon entropy of a string"""
            if len(string) == 0:
                return 0
            entropy = 0
            for count in Counter(string).values():
                p = count / len(string)
                entropy -= p * math.log2(p)
            return entropy

        def scan_file_for_high_entropy(filepath, threshold=4.5):
            """Scan file for high-entropy strings that might be secrets"""
            try:
                with open(filepath, 'r', encoding='utf-8', errors='ignore') as file:
                    content = file.read()
                    
                # Look for strings that might be secrets (base64-like, hex-like)
                patterns = [
                    r'[A-Za-z0-9+/]{20,}={0,2}',  # Base64-like
                    r'[a-fA-F0-9]{32,}',          # Hex strings
                    r'[A-Za-z0-9]{20,}'           # General alphanumeric
                ]
                
                for pattern in patterns:
                    matches = re.finditer(pattern, content)
                    for match in matches:
                        string = match.group()
                        if len(string) >= 20 and calculate_entropy(string) > threshold:
                            print(f"High entropy string in {filepath}: {string[:50]}...")
                            return True
                return False
            except Exception as e:
                print(f"Error scanning {filepath}: {e}")
                return False

        # Scan common file types
        extensions = ['.py', '.js', '.ts', '.json', '.yaml', '.yml', '.env', '.config']
        high_entropy_found = False

        for root, dirs, files in os.walk('.'):
            # Skip .git and node_modules
            dirs[:] = [d for d in dirs if d not in ['.git', 'node_modules', '__pycache__']]
            
            for file in files:
                if any(file.endswith(ext) for ext in extensions):
                    filepath = os.path.join(root, file)
                    if scan_file_for_high_entropy(filepath):
                        high_entropy_found = True

        if high_entropy_found:
            print("‚ö†Ô∏è  High entropy strings detected - manual review recommended")
            exit(1)
        else:
            print("‚úÖ No high entropy strings detected")
        EOF

    - name: Generate Security Report
      if: always()
      run: |
        echo "# Secret Scan Security Report" > security-report.md
        echo "Generated on: $(date)" >> security-report.md
        echo "" >> security-report.md
        
        echo "## Scan Summary" >> security-report.md
        echo "- Repository: ${{ github.repository }}" >> security-report.md
        echo "- Branch: ${{ github.ref_name }}" >> security-report.md
        echo "- Commit: ${{ github.sha }}" >> security-report.md
        echo "" >> security-report.md
        
        echo "## Tools Used" >> security-report.md
        echo "- ‚úÖ TruffleHog OSS" >> security-report.md
        echo "- ‚úÖ GitLeaks" >> security-report.md
        echo "- ‚úÖ Semgrep" >> security-report.md
        echo "- ‚úÖ detect-secrets" >> security-report.md
        echo "- ‚úÖ secretlint" >> security-report.md
        echo "- ‚úÖ Custom Pattern Matching" >> security-report.md
        echo "- ‚úÖ Entropy Analysis" >> security-report.md
        echo "" >> security-report.md
        
        echo "## Recommendations" >> security-report.md
        echo "1. Never commit secrets to version control" >> security-report.md
        echo "2. Use environment variables or secure secret stores" >> security-report.md
        echo "3. Rotate any secrets that may have been exposed" >> security-report.md
        echo "4. Enable GitHub secret scanning and push protection" >> security-report.md
        echo "5. Use .gitignore for sensitive files" >> security-report.md

    - name: Upload Security Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: secret-scan-report
        path: security-report.md

    - name: Comment PR with results
      if: github.event_name == 'pull_request' && failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'üîí **Secret Scan Failed**\n\nPotential secrets detected in this PR. Please review the action logs and remove any sensitive information before merging.\n\nüìã [View detailed report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})'
          })

  # Additional job for branch protection
  require-secret-scan:
    name: Require Secret Scan Success
    runs-on: ubuntu-latest
    needs: secret-scan
    if: always()
    steps:
    - name: Check secret scan results
      run: |
        if [[ "${{ needs.secret-scan.result }}" != "success" ]]; then
          echo "‚ùå Secret scan failed - blocking merge"
          exit 1
        else
          echo "‚úÖ Secret scan passed - safe to proceed"
        fi